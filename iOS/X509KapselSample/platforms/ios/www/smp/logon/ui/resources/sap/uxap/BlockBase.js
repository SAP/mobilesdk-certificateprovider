/*!
 * SAP.${maven.build.timestamp} UI development toolkit for HTML5 (SAPUI5) (c) Copyright
 * 		2009-2014 SAP SE. All rights reserved
 */
jQuery.sap.declare("sap.uxap.BlockBase");jQuery.sap.require("sap.uxap.library");jQuery.sap.require("sap.ui.core.Control");sap.ui.core.Control.extend("sap.uxap.BlockBase",{metadata:{publicMethods:["getSupportedModes"],library:"sap.uxap",properties:{"columnLayout":{type:"sap.uxap.BlockBaseColumnLayout",group:"Behavior",defaultValue:'auto'},"showSubSectionMore":{type:"boolean",group:"Behavior",defaultValue:false},"visible":{type:"boolean",group:"Appearance",defaultValue:true},"mode":{type:"string",group:"",defaultValue:null}},aggregations:{"mappings":{type:"sap.uxap.ModelMapping",multiple:true,singularName:"mapping"}},associations:{"selectedView":{type:"sap.ui.core.Control",multiple:false}}}});jQuery.sap.require("sap.ui.core.CustomData");jQuery.sap.require("sap.uxap.BlockBaseMetadata");jQuery.sap.require("sap.uxap.ModelMapping");sap.ui.core.Control.extend("sap.uxap.BlockBase",{metadata:{library:"sap.uxap",publicMethods:["getSupportedModes"],properties:{"mode":{type:"string",group:"Appearance"},"visible":{type:"boolean",group:"Appearance",defaultValue:true},"columnLayout":{type:"sap.uxap.BlockBaseColumnLayout",group:"Behavior",defaultValue:"auto"},"showSubSectionMore":{type:"boolean",group:"Behavior",defaultValue:false}},defaultAggregation:"mappings",aggregations:{"_views":{type:"sap.ui.core.Control",multiple:true,singularName:"view",visibility:"hidden"},"mappings":{type:"sap.uxap.ModelMapping",multiple:true,singularName:"mapping"}},associations:{"selectedView":{type:"sap.ui.core.Control",multiple:false}},views:{}},renderer:"sap.uxap.BlockBaseRenderer"},sap.uxap.BlockBaseMetadata);
sap.uxap.BlockBase.prototype.init=function(){if(!this.getMetadata().hasViews()){this.getMetadata().setView("defaultXML",{viewName:this.getMetadata().getName(),type:"XML"})}this._oMappingApplied={};this._bLazyLoading=false;this._bConnected=false;this._oUpdatedModels={};this._oParentObjectPageLayout=undefined;this._oParentObjectPageSubSection=undefined};
sap.uxap.BlockBase.prototype.setParent=function(p,a,s){sap.ui.core.Control.prototype.setParent.call(this,p,a,s);if(p instanceof sap.uxap.ObjectPageSubSection){this._bLazyLoading=true;this._oParentObjectPageSubSection=p}};
sap.uxap.BlockBase.prototype.invalidate=function(o){this._applyMapping();sap.ui.core.Control.prototype.invalidate.call(this,o)};
sap.uxap.BlockBase.prototype.setModel=function(m,n){this._applyMapping(n);return sap.ui.core.Control.prototype.setModel.call(this,m,n)};
sap.uxap.BlockBase.prototype._applyMapping=function(){if(this._bLazyLoading&&!this._bConnected){jQuery.sap.log.debug("BlockBase ::: Ignoring the _applyMapping as the block is not connected")}else{var t=this;jQuery.each(this.getMappings(),function(i,m){var M,I=m.getInternalModelName(),e=m.getExternalPath(),E=m.getExternalModelName(),p;if(e){if(I==""||e==""){throw new Error("BlockBase :: incorrect mapping, one of the modelMapping property is empty")}if(!t.getModel(I)&&!t._oMappingApplied[I]){jQuery.sap.log.info("BlockBase :: mapping external model "+E+" to "+I);M=t.getModel(E);if(M){p=M.resolve(e,t.getBindingContext(E));t._oMappingApplied[I]=true;t.setBindingContext(new sap.ui.model.Context(M,p),I);sap.ui.core.Control.prototype.setModel.call(t,M,I)}}}})}};
sap.uxap.BlockBase.prototype.propagateProperties=function(n){if(this._bLazyLoading&&!this._bConnected&&!this._oUpdatedModels.hasOwnProperty(n)){this._oUpdatedModels[n]=true}else{this._applyMapping(n)}return sap.ui.core.Control.prototype.propagateProperties.call(this,n)};
sap.uxap.BlockBase.prototype.getSupportedModes=function(){var s=jQuery.extend({},this.getMetadata().getViews());for(var k in s){s[k]=k}return s};
sap.uxap.BlockBase.prototype.setMode=function(m){m=this._validateMode(m);if(this.getMode()!==m){this.setProperty("mode",m,false);if(!this._bLazyLoading||this._bConnected){this._initView(m)}}return this};
sap.uxap.BlockBase.prototype.onBeforeRendering=function(){if(!this.getMode()||this.getMode()===""){if(this.getMetadata().getView("defaultXML")){this.setMode("defaultXML")}else{jQuery.sap.log.error("BlockBase ::: there is no mode defined for rendering "+this.getMetadata().getName()+". You can either set a default mode on the block metadata or set the mode property before rendering the block.")}}if(!this._getObjectPageLayout()){this._findObjectPageLayout()}if(this._getObjectPageLayout()){this._bLazyLoading=this._getObjectPageLayout().getEnableLazyLoading()}else{this._bLazyLoading=false}};
sap.uxap.BlockBase.prototype.onAfterRendering=function(){if(this._getObjectPageLayout()){this._getObjectPageLayout()._adjustLayout()}};
sap.uxap.BlockBase.prototype.clone=function(){var a=-1,A=this.getAssociation("selectedView"),v=this.getAggregation("_views")||[];if(A){jQuery.each(v,function(i,V){if(V.getId()===A){a=i}return a<0})}var n=sap.ui.core.Control.prototype.clone.call(this);if(a>=0){n.setAssociation("selectedView",n.getAggregation("_views")[a])}return n};
sap.uxap.BlockBase.prototype._validateMode=function(m){this.validateProperty("mode",m);if(!this.getMetadata().getView(m)){var b=this.getMetadata()._sClassName||this.getId();if(this.getMetadata().getView("defaultXML")){jQuery.sap.log.warning("BlockBase :: no view defined for block "+b+" for mode "+m+", loading defaultXML instead");m="defaultXML"}else{throw new Error("BlockBase :: no view defined for block "+b+" for mode "+m)}}return m};
sap.uxap.BlockBase.prototype._getSelectedViewContent=function(){var v=null,s,V;s=this.getAssociation("selectedView");V=this.getAggregation("_views");if(V){for(var i=0;!v&&i<V.length;i++){if(V[i].getId()===s){v=V[i]}}}return v};
sap.uxap.BlockBase.prototype.createView=function(p){return sap.ui.xmlview(p)};
sap.uxap.BlockBase.prototype._initView=function(m){var v,p,V;p=this.getMetadata().getView(m);V=this.getAggregation("_views")||[];for(var i=0;!v&&i<V.length;i++){if(V[i].data("layoutMode")===m){v=V[i]}}if(!v){v=this._getSelectedViewContent();if(!v||p.viewName!=v.getViewName()){v=this.createView(p);if(v){if(v.getController()){v.getController().oParentBlock=this}v.addCustomData(new sap.ui.core.CustomData({"key":"layoutMode","value":m}));this.addAggregation("_views",v,true)}else{throw new Error("BlockBase :: no view defined in metadata.views for mode "+m)}}}this.setAssociation("selectedView",v,true);if(v.getController()&&v.getController().onParentBlockModeChange){v.getController().onParentBlockModeChange(m)}else{jQuery.sap.log.info("BlockBase ::: could not notify "+p.viewName+" of loading in mode "+m+": missing controller onParentBlockModeChange method")}return v};
sap.uxap.BlockBase.prototype._findObjectPageLayout=function(){if(this._oParentObjectPageSubSection){this._oParentObjectPageLayout=this._oParentObjectPageSubSection.getParent();while(this._oParentObjectPageLayout&&!(this._oParentObjectPageLayout instanceof sap.uxap.ObjectPageLayout)){this._oParentObjectPageLayout=this._oParentObjectPageLayout.getParent()}}};
sap.uxap.BlockBase.prototype._getObjectPageLayout=function(){return this._oParentObjectPageLayout};
sap.uxap.BlockBase.prototype.setVisible=function(v,s){if(this._getObjectPageLayout()){this.setProperty("visible",v,true);this._getObjectPageLayout()._adjustLayoutAndUxRules();this.invalidate()}else{this.setProperty("visible",v,s)}return this};
sap.uxap.BlockBase.prototype.setShowSubSectionMore=function(v,i){if(v!=this.getShowSubSectionMore()){this.setProperty("showSubSectionMore",v,true);if(this._oParentObjectPageSubSection){this._oParentObjectPageSubSection.refreshSeeMoreVisibility()}}return this};
sap.uxap.BlockBase.prototype.connectToModels=function(){if(!this._bConnected){jQuery.sap.log.debug("BlockBase :: Connecting block to the UI5 model tree");this._bConnected=true;if(this._bLazyLoading){var m=this.getMode();if(m){this._initView(m)}}this.invalidate()}};
sap.uxap.BlockBase.prototype.updateBindingContext=function(s,S,m,u){if(!this._bLazyLoading||this._bConnected){return sap.ui.core.Control.prototype.updateBindingContext.call(this,s,S,m,u)}else{jQuery.sap.log.debug("BlockBase ::: Ignoring the updateBindingContext as the block is not visible for now in the ObjectPageLayout")}};
sap.uxap.BlockBase.prototype.updateBindings=function(u,m){if(!this._bLazyLoading||this._bConnected){return sap.ui.core.Control.prototype.updateBindings.call(this,u,m)}else{jQuery.sap.log.debug("BlockBase ::: Ignoring the updateBindingContext as the block is not visible for now in the ObjectPageLayout")}};
