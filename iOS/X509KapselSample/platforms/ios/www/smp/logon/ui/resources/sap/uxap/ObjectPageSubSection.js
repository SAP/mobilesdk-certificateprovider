/*!
 * SAP.${maven.build.timestamp} UI development toolkit for HTML5 (SAPUI5) (c) Copyright
 * 		2009-2014 SAP SE. All rights reserved
 */
jQuery.sap.declare("sap.uxap.ObjectPageSubSection");jQuery.sap.require("sap.uxap.library");jQuery.sap.require("sap.uxap.ObjectPageSectionBase");sap.uxap.ObjectPageSectionBase.extend("sap.uxap.ObjectPageSubSection",{metadata:{publicMethods:["refreshSeeMoreVisibility"],library:"sap.uxap",properties:{"mode":{type:"sap.uxap.ObjectPageSubSectionMode",group:"Appearance",defaultValue:sap.uxap.ObjectPageSubSectionMode.Collapsed}},defaultAggregation:"blocks",aggregations:{"_grid":{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"},"blocks":{type:"sap.ui.core.Control",multiple:true,singularName:"block"},"moreBlocks":{type:"sap.ui.core.Control",multiple:true,singularName:"moreBlock"},"actions":{type:"sap.ui.core.Control",multiple:true,singularName:"action"}}}});jQuery.sap.require("sap.uxap.ObjectPageSubSectionLayout");jQuery.sap.require("sap.ui.layout.Grid");jQuery.sap.require("sap.uxap.ObjectPageSubSectionMode");jQuery.sap.require("sap.ui.core.CustomData");
sap.uxap.ObjectPageSubSection.prototype.init=function(){sap.uxap.ObjectPageSectionBase.prototype.init.call(this);if(!sap.uxap.i18nModel){sap.uxap.i18nModel=new sap.ui.model.resource.ResourceModel({bundleUrl:jQuery.sap.getModulePath("sap.uxap.i18n.i18n",".properties")})}this.oResourceBundle=sap.uxap.i18nModel.getResourceBundle();this._oGrid=new sap.ui.layout.Grid({id:this.getId()+"-innerGrid",defaultSpan:"L12 M12 S12",hSpacing:1,vSpacing:1,width:"100%"});this.setAggregation("_grid",this._oGrid);this._buildSeeMoreControl();this._iResizeId=undefined;this._bRenderedFirstTime=false;this._aAggregationProxy={blocks:[],moreBlocks:[]};this._$spacer=[];this._switchSubSectionMode(this.getMode())};
sap.uxap.ObjectPageSubSection.prototype.connectToModels=function(){var b=this.getBlocks()||[],m=this.getMoreBlocks()||[];if(b.length>0){jQuery.each(b,jQuery.proxy(function(B,o){if(o instanceof sap.uxap.BlockBase){if(!o.getMode()){o.setMode(this.getMode())}o.connectToModels()}},this))}if(m.length>0&&this.getMode()==sap.uxap.ObjectPageSubSectionMode.Expanded){jQuery.each(m,jQuery.proxy(function(B,M){if(M instanceof sap.uxap.BlockBase){if(!M.getMode()){M.setMode(this.getMode())}M.connectToModels()}},this))}};
sap.uxap.ObjectPageSubSection.prototype.exit=function(){if(this._oSeeMoreButton){this._oSeeMoreButton.destroy();this._oSeeMoreButton=null}if(this._iResizeId){sap.ui.core.ResizeHandler.deregister(this._iResizeId)}if(sap.uxap.ObjectPageSectionBase.prototype.exit){sap.uxap.ObjectPageSectionBase.prototype.exit.call(this)}};
sap.uxap.ObjectPageSubSection.prototype.onAfterRendering=function(){if(sap.uxap.ObjectPageSectionBase.prototype.onAfterRendering){sap.uxap.ObjectPageSectionBase.prototype.onAfterRendering.call(this)}if(this._getObjectPageLayout()){switch(this._getObjectPageLayout().getSubSectionLayout()){case sap.uxap.ObjectPageSubSectionLayout.TitleOnLeft:this._afterRenderingTitleOnLeftLayout();break;default:}this._$spacer=jQuery.sap.byId(this._getObjectPageLayout().getId()+"-spacer")}};
sap.uxap.ObjectPageSubSection.prototype.onBeforeRendering=function(){if(sap.uxap.ObjectPageSectionBase.prototype.onBeforeRendering){sap.uxap.ObjectPageSectionBase.prototype.onBeforeRendering.call(this)}var v,l;this._setAggregationProxy();this._oGrid.removeAllContent();try{var c;if(this._getObjectPageLayout()){l=this._getObjectPageLayout().getSubSectionLayout()}switch(l){case sap.uxap.ObjectPageSubSectionLayout.TitleOnLeft:this._oGrid.setContainerQuery(false);c=2;break;default:this._oGrid.setContainerQuery(true);c=3}v=this._calcBlockColumnLayout(this.getBlocks(),c);jQuery.each(v,jQuery.proxy(function(i,b){this._setBlockMode(b,this.getMode());this._oGrid.addContent(b)},this));if(this.getMode()===sap.uxap.ObjectPageSubSectionMode.Expanded){v=this._calcBlockColumnLayout(this.getMoreBlocks(),c);jQuery.each(v,jQuery.proxy(function(i,m){this._setBlockMode(m,sap.uxap.ObjectPageSubSectionMode.Expanded);this._oGrid.addContent(m)},this))}}catch(e){jQuery.sap.log.error("ObjectPageSubSection :: error while building layout "+l+": "+e)}this.refreshSeeMoreVisibility()};
sap.uxap.ObjectPageSubSection.prototype.refreshSeeMoreVisibility=function(){var b=jQuery.isArray(this.getMoreBlocks())&&this.getMoreBlocks().length>0;if(!b){jQuery.each(this.getBlocks(),jQuery.proxy(function(i,B){if(B instanceof sap.uxap.BlockBase&&B.getVisible()&&B.getShowSubSectionMore()){b=true}return!b},this))}if(this.$().length>0){this.$().toggleClass("sapUxAPObjectPageSubSectionWithSeeMore",b)}this.toggleStyleClass("sapUxAPObjectPageSubSectionWithSeeMore",b);if(this._oSeeMoreButton.$().length>0){this._oSeeMoreButton.$().toggleClass("sapUxAPSubSectionSeeMoreButtonVisible",b)}this._oSeeMoreButton.toggleStyleClass("sapUxAPSubSectionSeeMoreButtonVisible",b);return b};
sap.uxap.ObjectPageSubSection.prototype.setMode=function(m){if(this.getMode()!==m){this._switchSubSectionMode(m);if(this._bRenderedFirstTime){this.rerender()}}return this};
sap.uxap.ObjectPageSubSection.prototype._calcBlockColumnLayout=function(b,c){var r,R,v=[];jQuery.each(b,jQuery.proxy(function(i,B){if(!this._bRenderedFirstTime&&B.getLayoutData()){B.destroyLayoutData();jQuery.sap.log.warning("ObjectPageSubSection :: forbidden use of layoutData for block "+B.getMetadata().getName(),"layout will be set by subSection")}if(!B.getVisible||B.getVisible()){v.push(B)}},this));r=c;R=2;jQuery.each(v,jQuery.proxy(function(i,B){var s,S;s=this._calculatedSize(B,r,v[i+1],v[i+2],c);if(c==3){S=this._calculatedSize(B,R,v[i+1],v[i+2],2)}else{S=s}B.setLayoutData(new sap.ui.layout.GridData({spanS:12,spanM:S*(12/2),spanL:s*(12/c),linebreakM:(i>0&&R===2),linebreakL:(i>0&&r===c)}));r-=s;if(r<=0){r=c}if(c!==1){R-=S;if(R<=0){R=2}}},this));return v};
sap.uxap.ObjectPageSubSection.prototype._calculatedSize=function(b,r,n,f,m){var c,C;if(!this._hasAutoLayout(b)){c=Math.min(m,window.parseInt(b.getColumnLayout(),10))}else{r-=1;C=this._calcLayout(n);if(C<=r){r-=C;C=this._calcLayout(f);if(C<=r){r-=C}}c=r+1}return c};
sap.uxap.ObjectPageSubSection.prototype._calcLayout=function(b){var l=1;if(!b){l=0}else if(b instanceof sap.uxap.BlockBase&&b.getColumnLayout()!="auto"){l=window.parseInt(b.getColumnLayout(),10)}return l};
sap.uxap.ObjectPageSubSection.prototype._hasAutoLayout=function(b){return!(b instanceof sap.uxap.BlockBase)||b.getColumnLayout()=="auto"};
sap.uxap.ObjectPageSubSection.prototype._afterRenderingTitleOnLeftLayout=function(){this._$standardHeader=jQuery.sap.byId(this.getId()+"-header");this._$grid=this._oGrid.$();if(!this._iResizeId){this._iResizeId=sap.ui.core.ResizeHandler.register(this,jQuery.proxy(this._titleOnLeftSynchronizeLayouts,this))}this._titleOnLeftSynchronizeLayouts()};
sap.uxap.ObjectPageSubSection.prototype._titleOnLeftSynchronizeLayouts=function(){jQuery.sap.delayedCall(50,this,function(){this._$standardHeader.toggleClass("titleOnLeftLayout",this._$grid.hasClass("sapUiRespGridMedia-Std-Desktop"))})};
sap.uxap.ObjectPageSubSection.prototype._setAggregationProxy=function(){if(this._bRenderedFirstTime){return}jQuery.each(this._aAggregationProxy,jQuery.proxy(function(a,v){this._setAggregation(a,this.removeAllAggregation(a))},this));this._bRenderedFirstTime=true};
sap.uxap.ObjectPageSubSection.prototype.hasProxy=function(a){return this._bRenderedFirstTime&&this._aAggregationProxy.hasOwnProperty(a)};
sap.uxap.ObjectPageSubSection.prototype._getAggregation=function(a){return this._aAggregationProxy[a]};
sap.uxap.ObjectPageSubSection.prototype._setAggregation=function(a,v){this._aAggregationProxy[a]=v;this._notifyObjectPageLayout();this.invalidate();return this._aAggregationProxy[a]};
sap.uxap.ObjectPageSubSection.prototype.addAggregation=function(a,o){if(this.hasProxy(a)){var A=this._getAggregation(a);A.push(o);this._setAggregation(A);return this}return sap.uxap.ObjectPageSectionBase.prototype.addAggregation.apply(this,arguments)};
sap.uxap.ObjectPageSubSection.prototype.insertAggregation=function(a,o,i){if(this.hasProxy(a)){jQuery.sap.log.warning("ObjectPageSubSection :: used of insertAggregation for "+a+" is not supported, will use addAggregation instead");return this.addAggregation(a,o)}return sap.uxap.ObjectPageSectionBase.prototype.insertAggregation.apply(this,arguments)};
sap.uxap.ObjectPageSubSection.prototype.removeAllAggregation=function(a){if(this.hasProxy(a)){var i=this._getAggregation(a);var I=i.slice(0,i.length-1);this._setAggregation(a,[]);return I}return sap.uxap.ObjectPageSectionBase.prototype.removeAllAggregation.apply(this,arguments)};
sap.uxap.ObjectPageSubSection.prototype.removeAggregation=function(a,o){if(this.hasProxy(a)){var r=false,i=this._getAggregation(a);jQuery.each(i,jQuery.proxy(function(I,O){if(O.getId()===o.getId()){i.splice(I,1);this._setAggregation(i);r=true}return!r},this));return(r?o:null)}return sap.uxap.ObjectPageSectionBase.prototype.removeAggregation.apply(this,arguments)};
sap.uxap.ObjectPageSubSection.prototype.indexOfAggregation=function(a,o){if(this.hasProxy(a)){var i=-1,I=this._getAggregation(a);jQuery.each(I,jQuery.proxy(function(b,O){if(O.getId()===o.getId()){i=b}return(i<0)},this));return i}return sap.uxap.ObjectPageSectionBase.prototype.indexOfAggregation.apply(this,arguments)};
sap.uxap.ObjectPageSubSection.prototype.getAggregation=function(a){if(this.hasProxy(a)){return this._getAggregation(a)}return sap.uxap.ObjectPageSectionBase.prototype.getAggregation.apply(this,arguments)};
sap.uxap.ObjectPageSubSection.prototype.destroyAggregation=function(a){if(this.hasProxy(a)){var i=this._getAggregation(a);jQuery.each(i,function(I,o){o.destroy()});this._setAggregation(a,[]);return this}return sap.uxap.ObjectPageSectionBase.prototype.destroyAggregation.apply(this,arguments)};
sap.uxap.ObjectPageSubSection.prototype._buildSeeMoreControl=function(){this._oSeeMoreButton=new sap.m.Button(this.getId()+"--seeMore",{type:sap.m.ButtonType.Transparent,iconFirst:false,press:jQuery.proxy(this._onSeeMorePress,this)}).addStyleClass("sapUxAPSubSectionSeeMoreButton")};
sap.uxap.ObjectPageSubSection.prototype._onSeeMorePress=function(e){var c=this.getMode(),t,m=this.getMoreBlocks()||[];if(c===sap.uxap.ObjectPageSubSectionMode.Expanded){t=sap.uxap.ObjectPageSubSectionMode.Collapsed}else{t=sap.uxap.ObjectPageSubSectionMode.Expanded;if(m.length>0){jQuery.each(m,jQuery.proxy(function(b,M){if(M instanceof sap.uxap.BlockBase){if(!M.getMode()){M.setMode(this.getMode())}M.connectToModels()}},this))}}this._switchSubSectionMode(t);if(!jQuery.device.is.phone){e.getSource().$().blur()}if(this._$spacer.length>0){this._$spacer.height(this._$spacer.height()+this.$().height())}this.rerender()};
sap.uxap.ObjectPageSubSection.prototype._switchSubSectionMode=function(s){s=this.validateProperty("mode",s);if(s===sap.uxap.ObjectPageSubSectionMode.Collapsed){this.setProperty("mode",sap.uxap.ObjectPageSubSectionMode.Collapsed,true);this._oSeeMoreButton.setText(this.oResourceBundle.getText("SEE_MORE"))}else{this.setProperty("mode",sap.uxap.ObjectPageSubSectionMode.Expanded,true);this._oSeeMoreButton.setText(this.oResourceBundle.getText("SEE_LESS"))}};
sap.uxap.ObjectPageSubSection.prototype._setBlockMode=function(b,m){if(b instanceof sap.uxap.BlockBase){b.setMode(m)}else{jQuery.sap.log.debug("ObjectPageSubSection :: cannot propagate mode "+m+" to "+b.getMetadata().getName())}};
