/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 * 
 *         (c) Copyright 2009-2014 SAP SE. All rights reserved
 *     
 */
jQuery.sap.declare("sap.me.OverlapCalendar");jQuery.sap.require("sap.me.library");jQuery.sap.require("sap.ui.core.Control");sap.ui.core.Control.extend("sap.me.OverlapCalendar",{metadata:{library:"sap.me",properties:{"startDate":{type:"string",group:"Data",defaultValue:null},"weeksPerRow":{type:"int",group:"Appearance",defaultValue:2},"firstDayOffset":{type:"int",group:"Appearance",defaultValue:0},"showOverlapIndicator":{type:"boolean",group:"Appearance",defaultValue:false},"visible":{type:"boolean",group:"Appearance",defaultValue:true},"swipeToNavigate":{type:"boolean",group:"Behavior",defaultValue:true},"width":{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:'100%'}},aggregations:{"calendarEvents":{type:"sap.me.OverlapCalendarEvent",multiple:true,singularName:"calendarEvent"},"calendar":{type:"sap.me.Calendar",multiple:false,visibility:"hidden"},"typeLabels":{type:"sap.m.Label",multiple:true,singularName:"typeLabel",visibility:"hidden"},"nameLabels":{type:"sap.m.Label",multiple:true,singularName:"nameLabel",visibility:"hidden"}},events:{"endOfData":{},"changeDate":{}}}});sap.me.OverlapCalendar.M_EVENTS={'endOfData':'endOfData','changeDate':'changeDate'};jQuery.sap.require("sap.me.Calendar");jQuery.sap.require("sap.ui.core.theming.Parameters");
sap.me.OverlapCalendar.prototype.init=function(){this.setAggregation("calendar",new sap.me.Calendar({singleRow:true,weeksPerRow:this.getWeeksPerRow(),monthsPerRow:1,monthsToDisplay:1,dayWidth:48,dayHeight:48,swipeToNavigate:this.getSwipeToNavigate()}));this.getCalendar().attachChangeCurrentDate(this.onCurrentDateChanged,this);this._typeWithBgImages=["04","07"];this._oDaysOverlap={}};
sap.me.OverlapCalendar.prototype.onswiperight=function(e){if(this.getSwipeToNavigate()){this.getCalendar().onswiperight(e)}};
sap.me.OverlapCalendar.prototype.onswipeleft=function(e){if(this.getSwipeToNavigate()){this.getCalendar().onswipeleft(e)}};
sap.me.OverlapCalendar.prototype.setSwipeToNavigate=function(s){this.getCalendar().setSwipeToNavigate(s);this.setProperty("swipeToNavigate",s,true)};
sap.me.OverlapCalendar.prototype._getFirstDateDisplayed=function(){var f=this.getCalendar().getFirstDayOffset();var c=this._createDateInDays(this.getStartDate());var C=c.getDate();var i=c.getDay();c.setDate(1);var d=i+1-f;c.setDate(C-d+1);return c};
sap.me.OverlapCalendar.prototype._getLastDateDisplayed=function(){var w=this.getCalendar().getDays();var W=w.length;var i=this.getCalendar().getWeeksPerRow();var d=i*W;var c=this._getFirstDateDisplayed();var t=this._createDateInDays(c.getTime());t.setDate(t.getDate()+d-1);return t};
sap.me.OverlapCalendar.prototype.setWeeksPerRow=function(w){this.getCalendar().setWeeksPerRow(w);this.setProperty("weeksPerRow",w)};
sap.me.OverlapCalendar.prototype.getCalendar=function(){return this.getAggregation("calendar")};
sap.me.OverlapCalendar.prototype.setStartDate=function(d){this.getCalendar().setFirstDayOffset(0);this.getCalendar().setCurrentDate(d);this.setProperty("startDate",d);var o=this._getDaysOffset(this._createDateInDays(d),this._getFirstDateDisplayed());this.getCalendar().setFirstDayOffset(o)};
sap.me.OverlapCalendar.prototype.onCurrentDateChanged=function(e){this.setProperty("startDate",e.getParameter("currentDate"),true);this.getCalendar().invalidate();this._renderCalendarEvents();this.fireChangeDate({firstDate:this._getFirstDateDisplayed(),endDate:this._getLastDateDisplayed()})};
sap.me.OverlapCalendar.prototype.onBeforeRendering=function(){this._cleanUp();this._aRows=[];this._lastDate=null;this._firstDate=null;var c=this.getCalendarEvents();jQuery.each(c,jQuery.proxy(this._parseCalendarEvent,this))};
sap.me.OverlapCalendar.prototype.onAfterRendering=function(){this._renderCalendarEvents();sap.ui.Device.resize.attachHandler(this._onResize,this)};
sap.me.OverlapCalendar.prototype._onResize=function(){if(this._sDelayedResize){jQuery.sap.clearIntervalCall(this._sDelayedResize)}this._sDelayedResize=jQuery.sap.delayedCall(200,this,this._fireRecomputeElementsSizes)};
sap.me.OverlapCalendar.prototype.exit=function(){this._cleanUp()};
sap.me.OverlapCalendar.prototype._cleanUp=function(){sap.ui.Device.resize.detachHandler(this._onResize,this)};
sap.me.OverlapCalendar.prototype._fireRecomputeElementsSizes=function(){var c=this.$();var e=c.find(".sapMeOverlapCalendarHalfDay");jQuery.merge(e,c.find(".sapMeOverlapCalendarRowLabels"));this._sizeElementsToParent(e)};
sap.me.OverlapCalendar.prototype._getDayId=function(d){var c=this._createDateInDays(this._getFirstDateDisplayed());return this._getDaysOffset(c,d)};
sap.me.OverlapCalendar.prototype._cleanUpDivs=function(){var c=this.$();c.find(".sapMeOverlapCalendarDay").removeClass().addClass("sapMeOverlapCalendarDay");c.find(".sapMeOverlapCalendarHalfDay").remove();c.find(".sapMeOverlapCalendarDay.sapMeOverlapCalendarDayWithHalf").removeClass(".sapMeOverlapCalendarDayWithHalf");c.find(".sapMeOverlapCalendarOverlap").css("background-color","transparent").css("border","none");c.find(".sapMeOverlapCalendarTypeLbl").remove()};
sap.me.OverlapCalendar.prototype._renderCalendarEvents=function(){var i;this._mHalfDays={};this._cleanUpDivs();this._oDaysOverlap={};var c=this.getCalendarEvents();jQuery.each(c,jQuery.proxy(this._renderCalendarEvent,this));jQuery.each(this._mHalfDays,jQuery.proxy(this._renderHalfDayCalendarEvent,this));if(this.getShowOverlapIndicator()){for(i in this._oDaysOverlap){if(this._oDaysOverlap[i]!=undefined&&this._oDaysOverlap[i]>1){var $=jQuery.sap.byId(this._provideId("overlap",i));$.css("background-color",sap.ui.core.theming.Parameters.get("sapMeOverlapCalendarIndicator"));$.css("border-right","1px solid "+sap.ui.core.theming.Parameters.get("sapMeOverlapCalendarIndicator"))}}}if(this._firstDate&&this._lastDate){var a=this._getFirstDateDisplayed();a.setDate(a.getDate()+7);var b=this._getLastDateDisplayed();b.setDate(b.getDate()-7);if((this._dayIsBefore(this._lastDate,a))){this.fireEndOfData({before:false})}else if(this._dayIsAfter(this._firstDate,b)){this.fireEndOfData({before:true})}}};
sap.me.OverlapCalendar.prototype._provideId=function(){var s=jQuery.makeArray(arguments).join("-");return this.getId()+"-"+s};
sap.me.OverlapCalendar.prototype._addToDayOverlap=function(d){if(this._oDaysOverlap[d]==undefined){this._oDaysOverlap[d]=0}this._oDaysOverlap[d]++};
sap.me.OverlapCalendar.prototype._getDaysOffset=function(f,s){return Math.floor(Math.abs(this._getRawDaysDifference(f,s)))};
sap.me.OverlapCalendar.prototype._getDaysDifference=function(f,s){var d=this._getRawDaysDifference(f,s);return(d<0)?Math.ceil(d):Math.floor(d)};
sap.me.OverlapCalendar.prototype._getRawDaysDifference=function(f,s){var O=86400000;var d=f.getTime();var a=s.getTime();var b=d-a;return(b/O)};
sap.me.OverlapCalendar.prototype._dayIsAfter=function(d,a){return(this._getDaysDifference(d,a)>0)};
sap.me.OverlapCalendar.prototype._dayIsBefore=function(d,a){return(this._getDaysDifference(d,a)<0)};
sap.me.OverlapCalendar.prototype._createDateInDays=function(d){var a=new Date(d);a.setHours(0);a.setMinutes(0);a.setSeconds(0);a.setMilliseconds(0);return a};
sap.me.OverlapCalendar.prototype._sizeElementsToParent=function(e){var c=(e!==null&&e.length)?e.length:0;var $,a;var i,w,h;for(i=0;i<c;i++){$=jQuery(e[i]);if($){a=$.parent();w=a.width();h=a.height();$.width(w).height(h)}}};
sap.me.OverlapCalendar.prototype._renderHalfDayCalendarEvent=function(k,h){var e=h[0];var $=jQuery.sap.byId(k);var t=e.getType();var b=(jQuery.inArray(t,this._typeWithBgImages)>-1);$.addClass("sapMeOverlapCalendarDayWithHalf");var a=jQuery("<div/>");a.addClass("sapMeOverlapCalendarHalfDay").addClass("sapMeOverlapCalendarType"+t+"HalfDayStart");$.append(a);var c=null;if(h.length>1){var d=h[1];var f=d.getType();c=jQuery("<div/>");c.addClass("sapMeOverlapCalendarHalfDay").addClass("sapMeOverlapCalendarType"+f+"HalfDayEnd")}else if(b){c=jQuery("<div/>");c.addClass("sapMeOverlapCalendarHalfDay").addClass("sapMeOverlapCalendarTypeHalfDayEnd")}if(null!==c){$.append(c)}this._sizeElementsToParent([a,c])};
sap.me.OverlapCalendar.prototype._defineFirstAndLastDates=function(s,e){if(this._lastDate==undefined){this._lastDate=e}if(this._dayIsAfter(e,this._lastDate)){this._lastDate=e}if(this._firstDate==undefined){this._firstDate=s}if(this._dayIsBefore(s,this._firstDate)){this._firstDate=s}};
sap.me.OverlapCalendar.prototype._renderCalendarEvent=function(i,c){var s=this._createDateInDays(c.getStartDay());var e=this._createDateInDays(c.getEndDay());this._defineFirstAndLastDates(s,e);var a=this._getFirstDateDisplayed();var l=this._getLastDateDisplayed();if((!this._dayIsBefore(e,a))&&(!this._dayIsAfter(s,l))){var r=c.getRow();var d=this._dayIsAfter(s,a)?s:a;e=this._dayIsAfter(e,l)?l:e;var n=this._getDaysOffset(d,e)+1;var b=this._getDaysOffset(a,d);var f="sapMeOverlapCalendarType"+c.getType();var $=undefined;var g;if(c.getHalfDay()===true){g=this._getDayId(d);var h=this._provideId(r,g);if(this._mHalfDays[h]==undefined){this._mHalfDays[h]=[];$=jQuery.sap.byId(h)}this._mHalfDays[h].push(c)}else{while(!this._dayIsAfter(d,e)){g=this._getDayId(d);this._addToDayOverlap(g);$=jQuery.sap.byId(this._provideId(r,g));$.addClass(f);d.setDate(d.getDate()+1)}}if($!=undefined){this._createEventLabel(c,d,n,b)}}};
sap.me.OverlapCalendar.prototype._createEventLabel=function(c,d,n,a){var t=c.getTypeName();if(t&&t.length>0){var r=c.getRow();var l=this._provideId(r,this._getDayId(d));var b=this._provideId("row",r,"lbls");var $=jQuery.sap.byId(b);$.width(jQuery.sap.byId(this.getId()).width());var e=this._provideId("lbl",l);if(jQuery.sap.byId(e).length===0){var f=jQuery("<label dir='Inherit' id='"+e+"'>"+t+"</label>");$.append(f);f.addClass("sapMeOverlapCalendarTypeLbl sapMLabel");this._modifyLabel(f,n,a)}}};
sap.me.OverlapCalendar.prototype._modifyLabel=function($,n,a){var d=(100/(this.getCalendar().getWeeksPerRow()*7));var w=(n*d);$.width(w+"%");var o=(a*d);var m=(a==0)?1:0.5;var l=o+"%";$.css("left",l);$.css("padding-left",m+"rem")};
sap.me.OverlapCalendar.prototype._parseCalendarEvent=function(i,c){var r=c.getRow();if(r!=-1){if(c.getName()!=undefined){if(this._aRows[r]==undefined&&c.getName()!=""){this._aRows[r]=c.getName()}}else{jQuery.sap.log.debug("Calendar event has no name")}}else{jQuery.sap.log.debug("Invalid calendar event row")}};
sap.me.OverlapCalendar.prototype._getLabelForRow=function(i){return this._getLabel(this._aRows[i],"nameLabels").addStyleClass("sapMeOverlapCalendarNameLbl")};
sap.me.OverlapCalendar.prototype._getLabel=function(t,a){var l=new sap.m.Label({text:t});this.addAggregation(a,l,true);return l};
