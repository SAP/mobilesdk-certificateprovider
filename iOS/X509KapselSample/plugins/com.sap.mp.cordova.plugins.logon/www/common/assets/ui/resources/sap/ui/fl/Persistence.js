/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 * 
 * (c) Copyright 2009-2014 SAP SE. All rights reserved
 */
sap.ui.define(["sap/ui/fl/Change","sap/ui/fl/DefaultVariant","sap/ui/fl/Utils","jquery.sap.global","sap/ui/fl/LrepConnector","sap/ui/fl/Cache"],function(C,d,U,$,L,a){var P=function(c,s){this._oControl=c;this._bHasLoadedChangesFromBackend=false;this._sStableIdPropertyName=s||'id';this._sStableId=this._getStableId();this._sComponentName=U.getComponentClassName(c);if(!this._sComponentName){jQuery.sap.log.error("The Control does not belong to a SAPUI5 component. Variants and Changes for this control might not work as expected.")}this._oChanges={};this._oConnector=this._createLrepConnector()};P.prototype._createLrepConnector=function(){var x,p;x=U.getXSRFTokenFromControl(this._oControl);p={XsrfToken:x};return new L(p)};P.prototype._getStableId=function(){if(!this._oControl){return}if((this._sStableIdPropertyName)&&(this._sStableIdPropertyName!=='id')){return this._oControl.getProperty(this._sStableIdPropertyName)}return this._oControl.getId()};P.prototype.getChanges=function(){var t=this;var c=this._sComponentName;if(this._bHasLoadedChangesFromBackend===true){return Promise.resolve(this._oChanges)}return a.getChangesFillingCache(this._oConnector,c).then(function(f){t._fillRelevantChanges(f);t._bHasLoadedChangesFromBackend=true;return t._oChanges})};P.prototype._fillRelevantChanges=function(f){var c,l,o,s,b,j,e,t;t=this;if(f&&f.changes&&f.changes.changes){c=f.changes.changes;l=c.length;for(j=0;j<l;j++){o=c[j];s=o.selector;if(s){jQuery.each(s,function(i,v){if(t._sStableId===v){b=new C(o,jQuery.proxy(t._deleteChange,t));e=b.getId();if(b.isValid()){if(t._oChanges[e]){jQuery.sap.log.error("Id collision - two or more change files having the same id detected: "+e);jQuery.each(b.getDefinition().texts,function(k,g){jQuery.sap.log.error("key : "+k+" and text : "+g.value)});jQuery.sap.log.error("already exists in change : ");jQuery.each(t._oChanges[e].getDefinition().texts,function(k,g){jQuery.sap.log.error("key : "+k+" and text : "+g.value)})}t._oChanges[e]=b}return false}})}}}};P.prototype.getChange=function(i){if(!i){jQuery.sap.log.error("sap.ui.fl.Persistence.getChange : sId is not defined")}return this._oChanges[i]};P.prototype.addChange=function(p){var f,i,c,I;if(!p){return}if(!p.type){jQuery.sap.log.error("sap.ui.fl.Persistence.addChange : type is not defined")}if(!p.ODataService){jQuery.sap.log.error("sap.ui.fl.Persistence.addChange : ODataService is not defined")}var s=jQuery.type(p.content);if(s!=='object'&&s!=='array'){jQuery.sap.log.error("mParameters.content is not of expected type object or array, but is: "+s,"sap.ui.fl.Persistence#addChange")}I={};if(typeof(p.texts)==="object"){jQuery.each(p.texts,function(b,t){I[b]={value:t,type:"XFLD"}})}i={changeType:p.type,service:p.ODataService,texts:I,content:p.content,componentName:this._sComponentName,isVariant:p.isVariant,namespace:this._sComponentName,packageName:p.packageName,isUserDependent:p.isUserDependent};i.selector=this._getSelector();f=C.createInitialFileContent(i);c=new C(f,jQuery.proxy(this._deleteChange,this));this._oChanges[c.getId()]=c;return c.getId()};P.prototype._getSelector=function(){var s;s={};if(this._sStableIdPropertyName){s[this._sStableIdPropertyName]=this._sStableId}return s};P.prototype.getDefaultVariantId=function(){return this.getChanges().then(function(c){return d.getDefaultVariantId(c)})};P.prototype.getDefaultVariantIdSync=function(){return d.getDefaultVariantId(this._oChanges)};P.prototype.setDefaultVariantIdSync=function(D){var p,c;var s={};s[this._sStableIdPropertyName]=this._sStableId;p={defaultVariantId:D,component:this._sComponentName,selector:s};c=d.updateDefaultVariantId(this._oChanges,D);if(c){return c}c=d.createChangeObject(p,this._deleteChange.bind(this));this._oChanges[c.getId()]=c;return c};P.prototype.setDefaultVariantId=function(D){var p,c;var t=this;return this.getChanges().then(function(o){var s={};s[t._sStableIdPropertyName]=t._sStableId;p={defaultVariantId:D,component:t._sComponentName,selector:s};c=d.updateDefaultVariantId(o,D);if(c){return c}c=d.createChangeObject(p,t._deleteChange.bind(t));o[c.getId()]=c;return c})};P.prototype.saveAll=function(){var p=[];var t=this;jQuery.each(this._oChanges,function(i,c){switch(c.getPendingAction()){case"NEW":p.push(t._oConnector.create(c.getDefinition(),c.getRequest(),c.isVariant()).then(function(r){c.setResponse(r.response);if(a.isActive()){a.addChange(c.getComponent(),r.response)}return r}));break;case"UPDATE":p.push(t._oConnector.update(c.getDefinition(),c.getId(),c.getRequest(),c.isVariant()).then(function(r){c.setResponse(r.response);if(a.isActive()){a.updateChange(c.getComponent(),r.response)}return r}));break;case"DELETE":p.push(t._oConnector.deleteChange({sChangeName:c.getId(),sLayer:c.getLayer(),sNamespace:c.getNamespace(),sChangelist:c.getRequest()},c.isVariant()).then(function(r){delete t._oChanges[c.getId()];if(a.isActive()){a.deleteChange(c.getComponent(),c.getDefinition())}return r}));break;default:break}});return Promise.all(p)};P.prototype._deleteChange=function(i){var c=this.getChange(i);if(c.getPendingAction()==="NEW"){delete this._oChanges[i]}};return P},true);
